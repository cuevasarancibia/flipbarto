<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Moto Zorro Veloz - ¡Aventura con Preguntas de Bartolo!</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #70c5ce;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        #gameContainer {
            position: relative;
            width: 320px;
            height: 480px;
            border: 2px solid #000;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            background-color: #70c5ce; /* Fondo inicial */
        }
        canvas {
            display: block;
            background-color: transparent; 
        }
        .game-ui-element { 
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            text-align: center;
            z-index: 10;
        }
        #scoreDisplay {
            top: 20px;
            font-size: 30px;
            font-weight: bold;
        }
        #messageDisplay {
            top: 40%;
            font-size: 24px;
            font-weight: bold;
            display: none;
            padding: 15px;
            background-color: rgba(0,0,0,0.4);
            border-radius: 8px;
            width: 80%;
            box-sizing: border-box;
        }
        #finalVictoryMessage { 
            top: 0; left: 0; 
            width: 100%;
            height: 100%;
            background-color: rgba(0, 85, 120, 0.9); 
            z-index: 25; 
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            font-size: 28px; 
            font-weight: bold;
        }
        #finalVictoryMessage small {
            font-size: 18px;
            margin-top: 20px;
            font-weight: normal;
        }
        #pauseButton {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(0,0,0,0.6);
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            z-index: 11;
            display: flex; 
            justify-content: center;
            align-items: center;
        }
        .pauseIconBar { width: 5px; height: 20px; background-color: white; margin: 0 2px; }
        .playIconTriangle { width: 0; height: 0; border-top: 10px solid transparent; border-bottom: 10px solid transparent; border-left: 18px solid white; }
        
        #questionModal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 20; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; box-sizing: border-box; color: white; text-align: center;
        }
        #questionText { font-size: 17px; margin-bottom: 15px; line-height: 1.4; }
        #answerButtonsContainer button {
            display: block; width: 90%; margin: 8px auto; padding: 10px; font-size: 15px;
            background-color: #4CAF50; color: white; border: none; border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s;
        }
        #answerButtonsContainer button:hover { background-color: #45a049; }

        #difficultySelectionModal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 30; 
            display: none; /* Se mostrará después de cargar assets */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        #difficultySelectionModal h2 { margin-top: 0; margin-bottom: 20px; font-size: 22px; }
        #difficultySelectionModal label { display: block; margin: 15px 0 5px 0; font-size: 16px;}
        #difficultySlider { width: 80%; margin-bottom: 5px; }
        #difficultyValue { font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        #difficultySelectionModal .checkbox-container { margin: 20px 0; font-size: 16px; }
        #difficultySelectionModal .checkbox-container input { margin-right: 8px; vertical-align: middle;}
        #startGameButton {
            padding: 12px 25px; font-size: 18px; background-color: #28a745; color: white;
            border: none; border-radius: 5px; cursor: pointer; transition: background-color 0.3s;
            margin-top: 20px;
        }
        #startGameButton:hover { background-color: #218838; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="difficultySelectionModal">
            <h2>Selecciona la Dificultad</h2>
            <label for="difficultySlider">Nivel de Dificultad: <span id="difficultyValue">5</span></label>
            <input type="range" id="difficultySlider" min="1" max="10" value="5">
            
            <div class="checkbox-container">
                <input type="checkbox" id="progressiveDifficultyCheckbox">
                <label for="progressiveDifficultyCheckbox">Dificultad en Crecimiento (cada 3 puntos)</label>
            </div>

            <button id="startGameButton">Iniciar Juego</button>
        </div>

        <canvas id="gameCanvas"></canvas>
        <div id="scoreDisplay" class="game-ui-element" style="display: none;">0</div>
        <div id="messageDisplay" class="game-ui-element"></div> 
        <div id="finalVictoryMessage" class="game-ui-element"> ¡Eres lo mejor que hay, muchas gracias!!<br>¡GANASTE!
            <br><small>Pulsa para jugar de nuevo</small>
        </div>
        <div id="pauseButton" style="display: none;"></div> 
        <div id="questionModal">
            <div id="questionText"></div>
            <div id="answerButtonsContainer"></div>
        </div>
    </div>

    <script>
        // --- Elementos del DOM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const finalVictoryMessageDisplay = document.getElementById('finalVictoryMessage');
        const pauseButton = document.getElementById('pauseButton');
        const questionModal = document.getElementById('questionModal');
        const questionText = document.getElementById('questionText');
        const answerButtonsContainer = document.getElementById('answerButtonsContainer');
        const difficultySelectionModal = document.getElementById('difficultySelectionModal');
        const difficultySlider = document.getElementById('difficultySlider');
        const difficultyValueDisplay = document.getElementById('difficultyValue');
        const progressiveDifficultyCheckbox = document.getElementById('progressiveDifficultyCheckbox');
        const startGameButton = document.getElementById('startGameButton');

        canvas.width = 320; canvas.height = 480;

        // --- ASSETS ---
        const motoFoxImg = new Image();
        const pipeTopImg = new Image();
        const pipeBottomImg = new Image();
        const groundImg = new Image();
        const bgImg = new Image();
        const dancingFoxImg = new Image(); 

        // --- Variables del Juego ---
        let motoX, motoY, motoVelocity, motoSize;
        let gravity, currentGravity; 
        let pipes;
        let pipeWidth, pipeGap, currentPipeGap;
        let pipeOriginalSpeed, currentPipeSpeed;
        let score;
        let gameState = 'LOADING_ASSETS'; // Estado inicial
        let isPaused = false;
        let groundHeight = 50;
        let groundX = 0;

        let lastTime = 0;
        const TARGET_FPS = 60;

        let isAnsweringQuestion = false;
        let currentQuestionData = null;
        const questions = [ 
            { text: "¿Cuál es el nombre del niño que tiene una cama voladora?", options: ["a) Bernardo", "b) Bartolo", "c) Benjamín"], correctAnswerIndex: 1 },
            { text: "En la ciudad secreta de los Andes, ¿cuál es el principal problema que deben resolver Bartolo y sus nuevos amigos?", options: ["a) Una inundación que amenaza la ciudad.", "b) Un meteorito que ha tapado el cráter por donde sale el sol.", "c) La desaparición del libro de hechizos de la ciudad."], correctAnswerIndex: 1 },
            { text: "¿Cuál de estos animales NO es un personaje que Bartolo conoce en la ciudad secreta?", options: ["a) Pascual, el conejo.", "b) Valentín, el puma.", "c) Lorenzo, el loro."], correctAnswerIndex: 2 },
            { text: "¿Qué personaje ayuda a Bartolo y los animales a llegar al fondo del lago para buscar una solución al problema del meteorito?", options: ["a) Un cóndor gigante.", "b) Sofía, la niña, con un submarino especial.", "c) Un antiguo mapa encontrado en la biblioteca de la ciudad."], correctAnswerIndex: 1 },
            { text: "¿Qué utilizan finalmente para mover el meteorito que tapa el sol?", options: ["a) La fuerza combinada de todos los animales de la ciudad.", "b) Una erupción volcánica controlada.", "c) La propia cama mágica de Bartolo, usada de una forma ingeniosa."], correctAnswerIndex: 2 },
            { text: "¿Qué característica especial tiene la ciudad secreta en la cordillera, además de ser habitada por animales que hablan?", options: ["a) Los edificios están hechos de nubes.", "b) Dependen de un sol que sale por un cráter específico.", "c) Cambia de ubicación cada noche para no ser descubierta."], correctAnswerIndex: 1 },
            { text: "¿Cuál es uno de los mensajes o temas principales que se pueden extraer del libro \"La cama mágica de Bartolo\"?", options: ["a) La importancia de la tecnología sobre la naturaleza.", "b) La desconfianza hacia los extraños.", "c) El valor de la amistad, la colaboración y la creatividad para resolver problemas."], correctAnswerIndex: 2 },
            { text: "Al final de la aventura en la cordillera, ¿cómo regresa Bartolo a su hogar?", options: ["a) Los animales construyen una catapulta gigante.", "b) Su cama lo lleva de vuelta, aunque de una manera un tanto accidentada y veloz.", "c) Sofía lo acompaña en un avión especial."], correctAnswerIndex: 1 },
            { text: "¿Quién es Sofía en la historia?", options: ["a) La hermana de Bartolo que lo espera en casa.", "b) Una estrella que guía a Bartolo en su viaje.", "c) Una niña aventurera que vive en la ciudad secreta y ayuda a resolver el problema del sol."], correctAnswerIndex: 2 },
            { text: "¿Qué actitud o cualidad de Bartolo es fundamental para enfrentar los desafíos en la ciudad secreta?", options: ["a) Su escepticismo y cautela ante lo desconocido.", "b) Su ingenio y disposición a escuchar y valorar las ideas de los demás.", "c) Su fuerza física superior a la de los animales."], correctAnswerIndex: 1 }
        ];
        let totalQuestionsInGame = questions.length; 
        let questionsAnsweredCorrectlyThisSession = 0; 
        let availableQuestions = [];
        const questionMilestones = [3, 6, 11, 17, 20];
        let milestonesReached = [];
        let lastScoreThatTriggeredQuestion = 0;
        
        let currentDifficultyLevel = 5; 
        let progressiveDifficultyEnabled = false;
        let lastDifficultyIncreaseScore = 0;
        let pipeSpawnTimer = 0;
        let PIPE_SPAWN_INTERVAL, currentPipeSpawnInterval; 

        const difficultyParams = {
            gravity:           { min: 0.04, max: 0.20 }, 
            pipeSpeed:         { min: 0.7,  max: 3.5  }, 
            pipeSpawnInterval: { min: 4.0,  max: 1.0  }, 
            pipeGap:           { min: 250,  max: 110  }  
        };

        // --- Lista de Assets para Cargar ---
        const assetList = [
            {img: motoFoxImg,    src: './imagenes/motozorro.png',        placeholder: 'https://placehold.co/40x40/FFA500/FFFFFF?text=Z', name: 'motoFoxImg', fallbackColor: 'orange', fallbackText: 'Z'},
            {img: pipeTopImg,    src: './imagenes/tuberia_arriba.svg',   placeholder: 'https://placehold.co/64x200/008000/FFFFFF?text=T', name: 'pipeTopImg', fallbackColor: 'green', fallbackText: 'T'},
            {img: pipeBottomImg, src: './imagenes/tuberia_abajo.svg',  placeholder: 'https://placehold.co/64x200/008000/FFFFFF?text=T', name: 'pipeBottomImg', fallbackColor: 'green', fallbackText: 'T'},
            {img: groundImg,     src: './imagenes/suelo.svg',            placeholder: `https://placehold.co/${canvas.width}x${groundHeight}/D2B48C/000000?text=S`, name: 'groundImg', fallbackColor: '#A0522D', fallbackText: 'S'}, 
            {img: bgImg,         src: './imagenes/fondo_juego.svg',      placeholder: `https://placehold.co/${canvas.width}x${canvas.height - groundHeight}/70C5CE/FFFFFF?text=F`, name: 'bgImg', fallbackColor: '#87CEEB', fallbackText: 'F'} 
        ];
        let assetsToLoadCount = assetList.length + 1; // +1 para el GIF de dancingFox
        let assetsLoadedCount = 0;


        function applyDifficultySettings(level) {
            const factor = (level - 1) / 9; 
            gravity = difficultyParams.gravity.min + (difficultyParams.gravity.max - difficultyParams.gravity.min) * factor;
            pipeOriginalSpeed = difficultyParams.pipeSpeed.min + (difficultyParams.pipeSpeed.max - difficultyParams.pipeSpeed.min) * factor;
            PIPE_SPAWN_INTERVAL = difficultyParams.pipeSpawnInterval.max - (difficultyParams.pipeSpawnInterval.max - difficultyParams.pipeSpawnInterval.min) * factor; 
            pipeGap = difficultyParams.pipeGap.max - (difficultyParams.pipeGap.max - difficultyParams.pipeGap.min) * factor; 
            currentGravity = gravity;
            currentPipeSpeed = pipeOriginalSpeed;
            currentPipeSpawnInterval = PIPE_SPAWN_INTERVAL;
            currentPipeGap = pipeGap;
            console.log(`Dificultad Nivel ${level}: G=${gravity.toFixed(3)}, Speed=${pipeOriginalSpeed.toFixed(2)}, Spawn=${PIPE_SPAWN_INTERVAL.toFixed(2)}s, Gap=${pipeGap.toFixed(0)}px`);
        }

        function increaseDifficultyStep() {
            currentGravity += 0.003; 
            currentPipeSpeed += 0.08;   
            if (currentPipeSpawnInterval > 0.8) currentPipeSpawnInterval -= 0.04; 
            if (currentPipeGap > 100) currentPipeGap -= 2; 
            console.log(`Dificultad Progresiva: G=${currentGravity.toFixed(3)}, Speed=${currentPipeSpeed.toFixed(2)}, Spawn=${currentPipeSpawnInterval.toFixed(2)}s, Gap=${currentPipeGap.toFixed(0)}px`);
        }

        function initGameLogic() { 
            motoSize = 40; motoX = 60; motoY = canvas.height / 2 - motoSize / 2;
            motoVelocity = 0; 
            pipes = []; pipeWidth = 64; 
            score = 0; 
            isPaused = false; 
            isAnsweringQuestion = false; questionModal.style.display = 'none';
            finalVictoryMessageDisplay.style.display = 'none'; 
            messageDisplay.style.display = 'none'; 
            scoreDisplay.style.display = 'block'; 
            pauseButton.style.display = 'flex';   
            availableQuestions = [...questions]; 
            questionsAnsweredCorrectlyThisSession = 0; 
            milestonesReached = [];
            lastScoreThatTriggeredQuestion = 0;
            lastDifficultyIncreaseScore = 0; 
            pipeSpawnTimer = currentPipeSpawnInterval; 
            lastTime = 0; 
            updatePauseButtonIcon();
            scoreDisplay.textContent = score;
        }

        difficultySlider.addEventListener('input', (e) => {
            currentDifficultyLevel = parseInt(e.target.value);
            difficultyValueDisplay.textContent = currentDifficultyLevel;
        });

        startGameButton.addEventListener('click', () => {
            applyDifficultySettings(currentDifficultyLevel);
            progressiveDifficultyEnabled = progressiveDifficultyCheckbox.checked;
            difficultySelectionModal.style.display = 'none'; 
            gameState = 'READY'; 
            messageDisplay.innerHTML = 'Pulsa o haz clic<br>para Empezar la Aventura';
            messageDisplay.style.display = 'block';
        });
        
        function drawGenericFallback(x, y, width, height, color, text) {
            ctx.fillStyle = color;
            ctx.fillRect(x, y, width, height);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, x + width / 2, y + height / 2);
        }

        function drawMoto() { 
            ctx.save();
            ctx.translate(motoX + motoSize / 2, motoY + motoSize / 2);
            let angle = Math.min(Math.PI / 8, motoVelocity * 0.08); ctx.rotate(angle);
            const asset = assetList.find(a => a.name === 'motoFoxImg');
            if (asset.img.complete && asset.img.naturalWidth > 0) {
                ctx.drawImage(asset.img, -motoSize / 2, -motoSize / 2, motoSize, motoSize);
            } else {
                drawGenericFallback(-motoSize / 2, -motoSize / 2, motoSize, motoSize, asset.fallbackColor, asset.fallbackText);
            }
            ctx.restore();
        }
        function drawPipes() { 
            const assetTop = assetList.find(a => a.name === 'pipeTopImg');
            const assetBottom = assetList.find(a => a.name === 'pipeBottomImg');
            pipes.forEach(pipe => {
                if (assetTop.img.complete && assetTop.img.naturalWidth > 0) {
                    ctx.drawImage(assetTop.img, pipe.x, 0, pipeWidth, pipe.topHeight);
                } else { 
                    drawGenericFallback(pipe.x, 0, pipeWidth, pipe.topHeight, assetTop.fallbackColor, assetTop.fallbackText);
                }
                if (assetBottom.img.complete && assetBottom.img.naturalWidth > 0) {
                    ctx.drawImage(assetBottom.img, pipe.x, pipe.topHeight + currentPipeGap, pipeWidth, canvas.height - pipe.topHeight - currentPipeGap - groundHeight);
                } else { 
                    drawGenericFallback(pipe.x, pipe.topHeight + currentPipeGap, pipeWidth, canvas.height - pipe.topHeight - currentPipeGap - groundHeight, assetBottom.fallbackColor, assetBottom.fallbackText);
                }
            });
        }
        function drawGround() { 
            const asset = assetList.find(a => a.name === 'groundImg');
            if (asset.img.complete && asset.img.naturalWidth > 0 && asset.img.width > 0) {
                 for (let i = 0; (i * asset.img.width) + groundX < canvas.width + asset.img.width; i++) {
                    ctx.drawImage(asset.img, (i * asset.img.width) + groundX, canvas.height - groundHeight, asset.img.width, groundHeight);
                }
            } else {
                 for (let i = 0; (i * canvas.width) + groundX < canvas.width + canvas.width; i++) { 
                    drawGenericFallback((i * canvas.width) + groundX, canvas.height - groundHeight, canvas.width, groundHeight, asset.fallbackColor, asset.fallbackText);
                 }
            }
        }
        function drawBackground() { 
            const asset = assetList.find(a => a.name === 'bgImg');
            if (asset.img.complete && asset.img.naturalWidth > 0 && asset.img.width > 0) { 
                 for (let i = 0; (i * asset.img.width) + (groundX * 0.5) < canvas.width + asset.img.width; i++) {
                    let bgX = (i * asset.img.width) + (groundX * 0.5);
                    while (bgX <= -asset.img.width && asset.img.width > 0) { bgX += asset.img.width; }
                    ctx.drawImage(asset.img, bgX , 0, asset.img.width, canvas.height - groundHeight);
                }
            } else {
                drawGenericFallback(0, 0, canvas.width, canvas.height - groundHeight, asset.fallbackColor, asset.fallbackText);
            }
        }
        
        function updateMoto(deltaTime) { 
            motoVelocity += currentGravity * TARGET_FPS * deltaTime;
            motoY += motoVelocity * TARGET_FPS * deltaTime;
            if (motoY < -motoSize * 0.2) { 
                motoY = -motoSize * 0.2; 
                motoVelocity = currentGravity * 2 * TARGET_FPS * deltaTime; 
            }
        }

        function updatePipes(deltaT
