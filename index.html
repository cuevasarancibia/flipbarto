<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Moto Zorro Veloz - ¡Aventura con Preguntas de Bartolo!</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #70c5ce;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
        }
        #gameContainer {
            position: relative;
            width: 320px;
            height: 480px;
            border: 2px solid #000;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        canvas {
            display: block;
            background-color: transparent;
        }
        #scoreDisplay {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            z-index: 10;
        }
        #messageDisplay {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-align: center;
            text-shadow: 2px 2px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000;
            z-index: 10;
            display: none;
            padding: 15px;
            background-color: rgba(0,0,0,0.4);
            border-radius: 8px;
            width: 80%;
            box-sizing: border-box;
        }
        #pauseButton {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background-color: rgba(0,0,0,0.6);
            border: 2px solid white;
            border-radius: 5px;
            cursor: pointer;
            z-index: 11;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .pauseIconBar {
            width: 5px;
            height: 20px;
            background-color: white;
            margin: 0 2px;
        }
        .playIconTriangle {
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 18px solid white;
        }

        /* Estilos para el Modal de Preguntas */
        #questionModal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 20;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            color: white;
            text-align: center;
        }
        #questionText {
            font-size: 17px; /* Ligeramente más pequeño para preguntas largas */
            margin-bottom: 15px;
            line-height: 1.4;
        }
        #answerButtonsContainer button {
            display: block;
            width: 90%; /* Un poco más ancho */
            margin: 8px auto; /* Menos margen vertical */
            padding: 10px; /* Un poco menos padding */
            font-size: 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #answerButtonsContainer button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="scoreDisplay">0</div>
        <div id="messageDisplay"></div>
        <div id="pauseButton"></div>
        <div id="questionModal">
            <div id="questionText"></div>
            <div id="answerButtonsContainer"></div>
        </div>
    </div>

    <script>
        // --- Elementos del DOM ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const messageDisplay = document.getElementById('messageDisplay');
        const pauseButton = document.getElementById('pauseButton');
        const questionModal = document.getElementById('questionModal');
        const questionText = document.getElementById('questionText');
        const answerButtonsContainer = document.getElementById('answerButtonsContainer');

        canvas.width = 320;
        canvas.height = 480;

        // --- ASSETS (Imágenes) ---
        const motoFoxImg = new Image(); motoFoxImg.src = './imagenes/motozorro.png';
        const pipeTopImg = new Image(); pipeTopImg.src = './imagenes/tuberia_arriba.svg';
        const pipeBottomImg = new Image(); pipeBottomImg.src = './imagenes/tuberia_abajo.svg';
        const groundImg = new Image(); groundImg.src = './imagenes/suelo.svg';
        const bgImg = new Image(); bgImg.src = './imagenes/fondo_juego.svg';
        const zorroVictoriaImg = new Image(); zorroVictoriaImg.src = './imagenes/zorro_victoria.jpg';
        const dancingFoxImg = new Image(); dancingFoxImg.src = 'data:image/gif;base64,R0lGODlhIAAgAPIEAAAAAP/OAAAA/84A////AAAAACH/C05FVFNDQVBFMi4wAwEAAAAh+QQJFAACACwAAAAAIAAgAAADXei63P4wykmrvTjrzbv/YCiOZGmeaKqubOu+cCzPdG3feK7vfO//wKBwSCwaj8ikcslsOp/QqHRKrVqv2Kx2y+16v+CweEwum8/otHrNbrvf8Lh8Tq/b7/i8fs/v+/+AgYKDhIWGh4iJiouMjY6PkJGSk5SVlpeYmZqbnJ2en6ChooqMhR0AAAAh+QQJFAACACwEAAIAFwAWAAADQHi63P4wykmrvTjrzbv/YCiOZGmeaKqubOu+cCzPdG3feK7vfO//wKAwSBQeiEghlHMpyfE0pFQrjVLjB+xOq3f0mJxbM9oVAAA7';

        // --- Variables del Juego ---
        let motoX, motoY, motoVelocity, motoSize;
        let gravity;
        let pipes;
        let pipeWidth, pipeGap, pipeSpeed;
        let score;
        let frames;
        let gameState;
        let isPaused = false;
        let groundHeight = 50;
        let groundX = 0;
        const scoreMetaInicial = 10; 
        let victoriaAlcanzada = false;

        // --- Variables para el Sistema de Preguntas ---
        let isAnsweringQuestion = false;
        let currentQuestionData = null;

        // --- BANCO DE PREGUNTAS ---
        const questions = [
            { text: "¿Cuál es el nombre del niño que tiene una cama voladora?", options: ["a) Bernardo", "b) Bartolo", "c) Benjamín"], correctAnswerIndex: 1 },
            { text: "En la ciudad secreta de los Andes, ¿cuál es el principal problema que deben resolver Bartolo y sus nuevos amigos?", options: ["a) Una inundación que amenaza la ciudad.", "b) Un meteorito que ha tapado el cráter por donde sale el sol.", "c) La desaparición del libro de hechizos de la ciudad."], correctAnswerIndex: 1 },
            { text: "¿Cuál de estos animales NO es un personaje que Bartolo conoce en la ciudad secreta?", options: ["a) Pascual, el conejo.", "b) Valentín, el puma.", "c) Lorenzo, el loro."], correctAnswerIndex: 2 },
            { text: "¿Qué personaje ayuda a Bartolo y los animales a llegar al fondo del lago para buscar una solución al problema del meteorito?", options: ["a) Un cóndor gigante.", "b) Sofía, la niña, con un submarino especial.", "c) Un antiguo mapa encontrado en la biblioteca de la ciudad."], correctAnswerIndex: 1 },
            { text: "¿Qué utilizan finalmente para mover el meteorito que tapa el sol?", options: ["a) La fuerza combinada de todos los animales de la ciudad.", "b) Una erupción volcánica controlada.", "c) La propia cama mágica de Bartolo, usada de una forma ingeniosa."], correctAnswerIndex: 2 },
            { text: "¿Qué característica especial tiene la ciudad secreta en la cordillera, además de ser habitada por animales que hablan?", options: ["a) Los edificios están hechos de nubes.", "b) Dependen de un sol que sale por un cráter específico.", "c) Cambia de ubicación cada noche para no ser descubierta."], correctAnswerIndex: 1 },
            { text: "¿Cuál es uno de los mensajes o temas principales que se pueden extraer del libro \"La cama mágica de Bartolo\"?", options: ["a) La importancia de la tecnología sobre la naturaleza.", "b) La desconfianza hacia los extraños.", "c) El valor de la amistad, la colaboración y la creatividad para resolver problemas."], correctAnswerIndex: 2 },
            { text: "Al final de la aventura en la cordillera, ¿cómo regresa Bartolo a su hogar?", options: ["a) Los animales construyen una catapulta gigante.", "b) Su cama lo lleva de vuelta, aunque de una manera un tanto accidentada y veloz.", "c) Sofía lo acompaña en un avión especial."], correctAnswerIndex: 1 },
            { text: "¿Quién es Sofía en la historia?", options: ["a) La hermana de Bartolo que lo espera en casa.", "b) Una estrella que guía a Bartolo en su viaje.", "c) Una niña aventurera que vive en la ciudad secreta y ayuda a resolver el problema del sol."], correctAnswerIndex: 2 },
            { text: "¿Qué actitud o cualidad de Bartolo es fundamental para enfrentar los desafíos en la ciudad secreta?", options: ["a) Su escepticismo y cautela ante lo desconocido.", "b) Su ingenio y disposición a escuchar y valorar las ideas de los demás.", "c) Su fuerza física superior a la de los animales."], correctAnswerIndex: 1 }
        ];
        let availableQuestions = [];
        const questionMilestones = [3, 6, 11, 17, 20]; // Hitos específicos para preguntas
        let milestonesReached = []; // Rastrea los hitos específicos ya usados
        let lastScoreThatTriggeredQuestion = 0; // Evita re-disparos en el mismo score

        function init() {
            motoSize = 40; motoX = 60; motoY = canvas.height / 2 - motoSize / 2;
            motoVelocity = 0; gravity = 0.05;
            pipes = []; pipeWidth = 64; pipeGap = 220; pipeSpeed = 0.8;
            score = 0; frames = 0;
            gameState = 'READY';
            isPaused = false; victoriaAlcanzada = false;
            isAnsweringQuestion = false; questionModal.style.display = 'none';
            
            availableQuestions = [...questions]; // Copia fresca de preguntas
            milestonesReached = []; // Reinicia hitos alcanzados
            lastScoreThatTriggeredQuestion = 0; // Reinicia el tracker

            updatePauseButtonIcon();
            scoreDisplay.textContent = score;
            messageDisplay.innerHTML = 'Pulsa o haz clic<br>para Empezar la Aventura';
            messageDisplay.style.display = 'block';
            messageDisplay.style.top = '40%';
            pauseButton.style.display = 'flex';
        }

        function drawMoto() {
            ctx.save();
            ctx.translate(motoX + motoSize / 2, motoY + motoSize / 2);
            let angle = Math.min(Math.PI / 8, motoVelocity * 0.08); ctx.rotate(angle);
            if (motoFoxImg.complete && motoFoxImg.naturalWidth !== 0) {
                ctx.drawImage(motoFoxImg, -motoSize / 2, -motoSize / 2, motoSize, motoSize);
            } else { ctx.fillStyle = 'orange'; ctx.fillRect(-motoSize / 2, -motoSize / 2, motoSize, motoSize); }
            ctx.restore();
        }

        function drawPipes() {
            pipes.forEach(pipe => {
                if (pipeTopImg.complete && pipeTopImg.naturalWidth !== 0) {
                    ctx.drawImage(pipeTopImg, pipe.x, 0, pipeWidth, pipe.topHeight);
                } else { ctx.fillStyle = 'green'; ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight); }
                if (pipeBottomImg.complete && pipeBottomImg.naturalWidth !== 0) {
                    ctx.drawImage(pipeBottomImg, pipe.x, pipe.topHeight + pipeGap, pipeWidth, canvas.height - pipe.topHeight - pipeGap - groundHeight);
                } else { ctx.fillStyle = 'green'; ctx.fillRect(pipe.x, pipe.topHeight + pipeGap, pipeWidth, canvas.height - pipe.topHeight - pipeGap - groundHeight); }
            });
        }

        function drawGround() {
            if (groundImg.complete && groundImg.naturalWidth !== 0 && groundImg.width > 0) {
                 for (let i = 0; (i * groundImg.width) + groundX < canvas.width + groundImg.width; i++) {
                    ctx.drawImage(groundImg, (i * groundImg.width) + groundX, canvas.height - groundHeight, groundImg.width, groundHeight);
                }
            } else { ctx.fillStyle = '#d2b48c'; ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight); }
        }

        function drawBackground() {
            if (bgImg.complete && bgImg.naturalWidth !== 0 && bgImg.width > 0) {
                 for (let i = 0; (i * bgImg.width) + (groundX * 0.5) < canvas.width + bgImg.width; i++) {
                    let bgX = (i * bgImg.width) + (groundX * 0.5);
                    while (bgX <= -bgImg.width && bgImg.width > 0) { bgX += bgImg.width; }
                    ctx.drawImage(bgImg, bgX , 0, bgImg.width, canvas.height - groundHeight);
                }
            }
        }

        function updateMoto() {
            motoVelocity += gravity; motoY += motoVelocity;
            if (motoY < -motoSize * 0.2) { motoY = -motoSize * 0.2; motoVelocity = gravity * 2; }
        }

        function updatePipes() {
            if (frames % 200 === 0) {
                let minTopHeight = 80;
                let maxTopHeightPossible = canvas.height - groundHeight - pipeGap - 80;
                let topHeight = Math.random() * (maxTopHeightPossible - minTopHeight) + minTopHeight;
                pipes.push({ x: canvas.width, topHeight: topHeight, passed: false });
            }

            pipes.forEach(pipe => {
                pipe.x -= pipeSpeed;
                if (pipe.x + pipeWidth < 0) { pipes.shift(); }

                if (!pipe.passed && pipe.x + pipeWidth < motoX) {
                    pipe.passed = true;
                    score++;
                    scoreDisplay.textContent = score;

                    let questionShouldBeTriggered = false;
                    
                    // 1. Verificar hitos específicos no alcanzados
                    for (let i = 0; i < questionMilestones.length; i++) {
                        const milestone = questionMilestones[i];
                        if (score === milestone && !milestonesReached.includes(milestone)) {
                            questionShouldBeTriggered = true;
                            milestonesReached.push(milestone); // Marcar hito como usado
                            break; 
                        }
                    }

                    // 2. Verificar múltiplos de 5 después de 20 (si no se activó por hito)
                    if (!questionShouldBeTriggered && score > 20 && score % 5 === 0) {
                        // Evitar re-trigger si este score ya activó una pregunta (como hito o múltiplo anterior)
                        if (!milestonesReached.includes(score) && score !== lastScoreThatTriggeredQuestion) {
                            questionShouldBeTriggered = true;
                        }
                    }
                    
                    if (questionShouldBeTriggered) {
                        if (!isAnsweringQuestion && gameState === 'PLAYING') {
                            triggerQuestion();
                            lastScoreThatTriggeredQuestion = score; // Registrar que este score disparó una pregunta
                        }
                    }

                    // Lógica de victoria (solo si no hay pregunta activa)
                    if (!isAnsweringQuestion) {
                        if (score === scoreMetaInicial && !victoriaAlcanzada) {
                            mostrarPantallaVictoriaIntermedia();
                        } else if (score === 9999 && gameState !== 'ENDING') {
                            enterEndingSequence();
                        }
                    }
                }
            });
        }

        function checkCollisions() {
            if (gameState !== 'PLAYING' || isAnsweringQuestion) return;
            if (motoY + motoSize > canvas.height - groundHeight) {
                motoY = canvas.height - groundHeight - motoSize;
                gameOver("¡Caíste al suelo!"); return;
            }
            for (let pipe of pipes) {
                const m = 2; // margen
                if (motoX + motoSize - m > pipe.x && motoX + m < pipe.x + pipeWidth &&
                    (motoY + m < pipe.topHeight || motoY + motoSize - m > pipe.topHeight + pipeGap)) {
                    gameOver("¡Chocaste con una tubería!"); return;
                }
            }
        }

        function updateGround() {
            groundX -= pipeSpeed;
            if (groundImg.complete && groundImg.naturalWidth !== 0 && groundImg.width > 0) {
                if (groundX <= -groundImg.width) { groundX += groundImg.width; }
            }
        }

        function flap() {
            if (gameState === 'PLAYING' && !isPaused && !isAnsweringQuestion) {
                motoVelocity = -2.8;
            }
        }

        function gameOver(reason = "¡Oh no, Zorro!") {
            if (gameState === 'GAMEOVER' || gameState === 'ENDING' || gameState === 'VICTORY_INTERMEDIATE') return;
            gameState = 'GAMEOVER'; isPaused = true;
            messageDisplay.innerHTML = `${reason}<br>Puntuación Final: ${score}<br><small>Pulsa para reintentar</small>`;
            messageDisplay.style.top = '40%'; messageDisplay.style.display = 'block';
            questionModal.style.display = 'none';
        }
        
        function mostrarPantallaVictoriaIntermedia() {
            if (gameState === 'ENDING' || isAnsweringQuestion) return;
            isPaused = true; victoriaAlcanzada = true; gameState = 'VICTORY_INTERMEDIATE';
            updatePauseButtonIcon(); ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (bgImg.complete && bgImg.naturalWidth !== 0) drawBackgroundStatic();
            else { ctx.fillStyle = '#70c5ce'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
            drawGroundStatic();
            if (zorroVictoriaImg.complete && zorroVictoriaImg.naturalWidth !== 0) {
                const imgW = zorroVictoriaImg.naturalWidth, imgH = zorroVictoriaImg.naturalHeight;
                let dW = canvas.width * 0.9, dH = (imgH / imgW) * dW;
                if (dH > canvas.height * 0.6) { dH = canvas.height * 0.6; dW = (imgW / imgH) * dH; }
                if (dW > canvas.width * 0.9) { dW = canvas.width * 0.9; dH = (imgH / imgW) * dW; }
                ctx.drawImage(zorroVictoriaImg, (canvas.width - dW) / 2, (canvas.height - dH) / 4, dW, dH);
                messageDisplay.innerHTML = `¡Lo lograron!<br>"¡Vamos a conseguir la hazaña de salvar al mundo!"<br><small>Pulsa para continuar</small>`;
            } else { messageDisplay.innerHTML = `¡FELICIDADES!<br>Alcanzaste ${scoreMetaInicial} puntos.<br><small>Pulsa para continuar</small>`; }
            messageDisplay.style.top = '75%'; messageDisplay.style.display = 'block';
            scoreDisplay.textContent = score;
        }

        function drawGroundStatic() {
            if (groundImg.complete && groundImg.naturalWidth !== 0 && groundImg.width > 0) {
                 for (let i = 0; (i * groundImg.width) < canvas.width + groundImg.width; i++) {
                    ctx.drawImage(groundImg, (i * groundImg.width), canvas.height - groundHeight, groundImg.width, groundHeight);
                }
            } else { ctx.fillStyle = '#d2b48c'; ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight); }
        }
        function drawBackgroundStatic() {
            if (bgImg.complete && bgImg.naturalWidth !== 0 && bgImg.width > 0) {
                 for (let i = 0; (i * bgImg.width) < canvas.width + bgImg.width; i++) {
                    ctx.drawImage(bgImg, (i * bgImg.width) , 0, bgImg.width, canvas.height - groundHeight);
                }
            }
        }

        function enterEndingSequence() {
            gameState = 'ENDING'; pipes = [];
            motoX = canvas.width / 2 - motoSize / 2; motoY = canvas.height - groundHeight - motoSize - 10;
            motoVelocity = 0; messageDisplay.innerHTML = `¡FIN DE LA AVENTURA!`;
            messageDisplay.style.top = '30%'; messageDisplay.style.display = 'block';
            pauseButton.style.display = 'none';
        }

        function drawEndingSequence() {
            ctx.fillStyle = '#303030'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#505050';
            for(let y=0; y<canvas.height; y+=20) for(let x=(y/20)%2===0?0:-10; x<canvas.width; x+=40) ctx.fillRect(x,y,38,18);
            ctx.fillStyle = '#404040'; ctx.fillRect(0, canvas.height - groundHeight + 10, canvas.width, groundHeight-10);
            const dFS = 64; // dancingFoxSize
            if (dancingFoxImg.complete && dancingFoxImg.naturalWidth !== 0) {
                 ctx.drawImage(dancingFoxImg, canvas.width/2 - dFS/2, canvas.height - groundHeight - dFS + 10, dFS, dFS);
            } else { ctx.fillStyle = 'orange'; ctx.fillRect(canvas.width/2 - motoSize/2, canvas.height - groundHeight - motoSize + 10, motoSize, motoSize); }
            ctx.fillStyle='orange'; ctx.fillRect(canvas.width*0.2-5,canvas.height*0.6-10,10,20); ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(canvas.width*0.2,canvas.height*0.6-15,7,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='orange'; ctx.fillRect(canvas.width*0.8-5,canvas.height*0.6-10,10,20); ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(canvas.width*0.8,canvas.height*0.6-15,7,0,Math.PI*2); ctx.fill();
            scoreDisplay.textContent = '9999';
        }

        function triggerQuestion() {
            if (availableQuestions.length === 0) {
                console.log("No hay más preguntas disponibles.");
                // Opcional: reiniciar availableQuestions = [...questions]; si se quiere repetir.
                // Por ahora, si se acaban, no se hacen más preguntas.
                isPaused = false; // Asegurar que el juego no quede pausado si no hay pregunta
                updatePauseButtonIcon();
                return; 
            }
            if (isAnsweringQuestion || gameState !== 'PLAYING') return;

            isAnsweringQuestion = true; isPaused = true;
            updatePauseButtonIcon();

            const questionIndex = Math.floor(Math.random() * availableQuestions.length);
            currentQuestionData = availableQuestions.splice(questionIndex, 1)[0];

            questionText.textContent = currentQuestionData.text;
            answerButtonsContainer.innerHTML = ''; 

            currentQuestionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.textContent = option;
                button.onclick = () => selectAnswer(index);
                answerButtonsContainer.appendChild(button);
            });
            questionModal.style.display = 'flex';
        }

        function selectAnswer(selectedIndex) {
            if (!currentQuestionData) return;

            if (selectedIndex === currentQuestionData.correctAnswerIndex) {
                score -= 5; 
                if (score < 0) score = 0; 
                scoreDisplay.textContent = score;
                // No es necesario actualizar lastScoreThatTriggeredQuestion aquí, ya se hizo al disparar.
                messageDisplay.innerHTML = "¡Correcto! Pierdes 5 puntos.<br>Continúa la aventura.";
                messageDisplay.style.display = 'block';
                setTimeout(() => {
                    messageDisplay.style.display = 'none';
                    isAnsweringQuestion = false; isPaused = false;
                    updatePauseButtonIcon(); questionModal.style.display = 'none';
                }, 2000); // Un poco más de tiempo para leer el mensaje
            } else {
                questionModal.style.display = 'none';
                gameOver("¡Respuesta incorrecta!");
            }
            currentQuestionData = null;
        }

        function gameLoop() {
            if (!isPaused || gameState === 'VICTORY_INTERMEDIATE') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (gameState === 'ENDING') { drawEndingSequence(); }
                else if (gameState === 'VICTORY_INTERMEDIATE') {
                    if (bgImg.complete && bgImg.naturalWidth !== 0) drawBackgroundStatic();
                    else { ctx.fillStyle = '#70c5ce'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
                    drawGroundStatic();
                    if (zorroVictoriaImg.complete && zorroVictoriaImg.naturalWidth !== 0) {
                        const imgW=zorroVictoriaImg.naturalWidth, imgH=zorroVictoriaImg.naturalHeight;
                        let dW=canvas.width*0.9,dH=(imgH/imgW)*dW;
                        if(dH > canvas.height*0.6){dH=canvas.height*0.6;dW=(imgW/imgH)*dH;}
                        if(dW > canvas.width*0.9){dW=canvas.width*0.9;dH=(imgH/imgW)*dW;}
                        ctx.drawImage(zorroVictoriaImg,(canvas.width-dW)/2,(canvas.height-dH)/4,dW,dH);
                    }
                } else {
                    drawBackground(); drawPipes(); drawGround(); drawMoto();
                    if (gameState === 'PLAYING' && !isPaused && !isAnsweringQuestion) {
                        updateMoto(); updatePipes(); updateGround(); checkCollisions(); frames++;
                    }
                }
            }
            requestAnimationFrame(gameLoop);
        }

        function handleInput() {
            if (isAnsweringQuestion) return;
            if (gameState === 'VICTORY_INTERMEDIATE') {
                isPaused = false; gameState = 'PLAYING';
                messageDisplay.style.display = 'none'; updatePauseButtonIcon(); return;
            }
            if (isPaused && gameState !== 'GAMEOVER' && gameState !== 'READY') return;

            if (gameState === 'READY') {
                gameState = 'PLAYING'; isPaused = false;
                messageDisplay.style.display = 'none'; pauseButton.style.display = 'flex';
                flap();
            } else if (gameState === 'PLAYING') { flap(); }
            else if (gameState === 'GAMEOVER' || gameState === 'ENDING') { init(); }
        }
        
        function togglePause() {
            if (isAnsweringQuestion || gameState === 'ENDING' || gameState === 'VICTORY_INTERMEDIATE' || gameState === 'GAMEOVER' || gameState === 'READY') return;
            if (gameState === 'PLAYING' || gameState === 'PAUSED') {
                isPaused = !isPaused; gameState = isPaused ? 'PAUSED' : 'PLAYING';
                messageDisplay.textContent = isPaused ? 'PAUSADO' : '';
                messageDisplay.style.display = isPaused ? 'block' : 'none';
                updatePauseButtonIcon();
            }
        }

        function updatePauseButtonIcon() {
            if (isPaused && !isAnsweringQuestion && gameState !== 'VICTORY_INTERMEDIATE') {
                 pauseButton.innerHTML = '<div class="playIconTriangle"></div>';
            } else {
                 pauseButton.innerHTML = '<div class="pauseIconBar"></div><div class="pauseIconBar"></div>';
            }
        }

        gameContainer.addEventListener('click', (event) => {
            if (event.target !== pauseButton && !pauseButton.contains(event.target) &&
                event.target !== questionModal && !questionModal.contains(event.target)) {
                handleInput();
            }
        });
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' || e.key === ' ') { e.preventDefault(); handleInput(); }
        });
        pauseButton.addEventListener('click', (event) => { event.stopPropagation(); togglePause(); });

        const allAssetPaths = [ motoFoxImg.src, pipeTopImg.src, pipeBottomImg.src, groundImg.src, bgImg.src, zorroVictoriaImg.src ];
        let assetsToLoadCount = allAssetPaths.length; let assetsLoadedCount = 0;
        function assetLoadedCallback(imgEl, imgP) {
            assetsLoadedCount++; console.log(`Asset cargado: ${imgP} (${assetsLoadedCount}/${assetsToLoadCount})`);
            if (assetsLoadedCount === assetsToLoadCount) { console.log("Assets cargados!"); init(); gameLoop(); }
        }
        function assetErrorCallback(imgEl, imgP) {
            console.error(`Error al cargar: ${imgP}.`); assetsLoadedCount++;
            if (assetsLoadedCount === assetsToLoadCount) { console.warn("Juego con assets faltantes."); init(); gameLoop(); }
        }
        allAssetPaths.forEach((path, index) => {
            const img = [motoFoxImg, pipeTopImg, pipeBottomImg, groundImg, bgImg, zorroVictoriaImg][index];
            img.onload = () => assetLoadedCallback(img, path);
            img.onerror = () => assetErrorCallback(img, path);
        });
        dancingFoxImg.onload = () => console.log("GIF cargado.");
        dancingFoxImg.onerror = () => console.warn('Error GIF.');
    </script>
</body>
</html>

